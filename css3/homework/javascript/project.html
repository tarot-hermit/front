<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>가계부 웹앱</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f7fb; }
    .card-summary .value { font-size: 1.4rem; font-weight: 700; }
    .badge-type { font-weight: 600; }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body>
<div class="container py-4" style="max-width: 980px;">
  <h2 class="mb-3">가계부 웹앱</h2>

  <!-- 요약 -->
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card card-summary shadow-sm">
        <div class="card-body">
          <div class="text-muted">수입</div>
          <div class="value" id="sumIncome">0원</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-summary shadow-sm">
        <div class="card-body">
          <div class="text-muted">지출</div>
          <div class="value" id="sumExpense">0원</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-summary shadow-sm">
        <div class="card-body">
          <div class="text-muted">잔액</div>
          <div class="value" id="sumBalance">0원</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 입력 폼 -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form id="form" class="row g-2 align-items-end">
        <div class="col-md-2">
          <label class="form-label">구분</label>
          <select class="form-select" id="type" required>
            <option value="expense">지출</option>
            <option value="income">수입</option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">날짜</label>
          <input type="date" class="form-control" id="date" required>
        </div>

        <div class="col-md-2">
          <label class="form-label">분류</label>
          <select class="form-select" id="category" required>
            <option value="식비">식비</option>
            <option value="교통">교통</option>
            <option value="쇼핑">쇼핑</option>
            <option value="문화">문화</option>
            <option value="주거/통신">주거/통신</option>
            <option value="기타">기타</option>
            <option value="급여">급여</option>
            <option value="용돈">용돈</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">내용</label>
          <input type="text" class="form-control" id="memo" placeholder="예: 점심, 버스" required>
        </div>

        <div class="col-md-2">
          <label class="form-label">금액</label>
          <input type="number" class="form-control" id="amount" min="1" step="1" required>
        </div>

        <div class="col-md-1 d-grid">
          <button class="btn btn-primary" type="submit">추가</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 필터/정렬 -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-2">
          <label class="form-label">월 필터</label>
          <input type="month" class="form-control" id="monthFilter">
        </div>
        <div class="col-md-2">
          <label class="form-label">구분</label>
          <select class="form-select" id="typeFilter">
            <option value="all">전체</option>
            <option value="expense">지출</option>
            <option value="income">수입</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">분류</label>
          <select class="form-select" id="categoryFilter">
            <option value="all">전체</option>
            <option value="식비">식비</option>
            <option value="교통">교통</option>
            <option value="쇼핑">쇼핑</option>
            <option value="문화">문화</option>
            <option value="주거/통신">주거/통신</option>
            <option value="기타">기타</option>
            <option value="급여">급여</option>
            <option value="용돈">용돈</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">검색(내용)</label>
          <input type="text" class="form-control" id="search" placeholder="예: 점심">
        </div>
        <div class="col-md-3">
          <label class="form-label">정렬</label>
          <select class="form-select" id="sort">
            <option value="dateDesc">날짜(최신)</option>
            <option value="dateAsc">날짜(오래된)</option>
            <option value="amountDesc">금액(큰)</option>
            <option value="amountAsc">금액(작은)</option>
          </select>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-outline-secondary btn-sm" id="resetFilters" type="button">필터 초기화</button>
        <button class="btn btn-outline-danger btn-sm ms-auto" id="clearAll" type="button">전체 삭제</button>
      </div>
    </div>
  </div>

  <!-- 리스트 -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
          <tr>
            <th style="width:120px;">날짜</th>
            <th style="width:90px;">구분</th>
            <th style="width:120px;">분류</th>
            <th>내용</th>
            <th class="text-end" style="width:140px;">금액</th>
            <th style="width:90px;">액션</th>
          </tr>
          </thead>
          <tbody id="tbody">
          </tbody>
        </table>
      </div>
      <div class="text-muted mt-2" id="countInfo"></div>
    </div>
  </div>
</div>

<script>
  'use strict';

  // ---------- 유틸 ----------
  const fmt = new Intl.NumberFormat('ko-KR');
  const toKRW = n => `${fmt.format(n)}원`;
  const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
  const STORAGE_KEY = 'moneybook_items_v1';

  // ---------- 상태 ----------
  let items = [];

  // ---------- DOM ----------
  const form = document.getElementById('form');
  const typeEl = document.getElementById('type');
  const dateEl = document.getElementById('date');
  const categoryEl = document.getElementById('category');
  const memoEl = document.getElementById('memo');
  const amountEl = document.getElementById('amount');

  const monthFilterEl = document.getElementById('monthFilter');
  const typeFilterEl = document.getElementById('typeFilter');
  const categoryFilterEl = document.getElementById('categoryFilter');
  const searchEl = document.getElementById('search');
  const sortEl = document.getElementById('sort');

  const tbody = document.getElementById('tbody');
  const countInfo = document.getElementById('countInfo');

  const sumIncomeEl = document.getElementById('sumIncome');
  const sumExpenseEl = document.getElementById('sumExpense');
  const sumBalanceEl = document.getElementById('sumBalance');

  // ---------- 저장/로드 ----------
  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  }
  function load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    items = raw ? JSON.parse(raw) : [];
  }

  // ---------- 필터/정렬 ----------
  function getFiltered() {
    let res = [...items];

    // 월 필터 (YYYY-MM)
    const mf = monthFilterEl.value;
    if (mf) res = res.filter(x => x.date.startsWith(mf));

    // 구분
    const tf = typeFilterEl.value;
    if (tf !== 'all') res = res.filter(x => x.type === tf);

    // 분류
    const cf = categoryFilterEl.value;
    if (cf !== 'all') res = res.filter(x => x.category === cf);

    // 검색
    const q = searchEl.value.trim().toLowerCase();
    if (q) res = res.filter(x => x.memo.toLowerCase().includes(q));

    // 정렬
    switch (sortEl.value) {
      case 'dateAsc':
        res.sort((a,b) => a.date.localeCompare(b.date));
        break;
      case 'dateDesc':
        res.sort((a,b) => b.date.localeCompare(a.date));
        break;
      case 'amountAsc':
        res.sort((a,b) => a.amount - b.amount);
        break;
      case 'amountDesc':
        res.sort((a,b) => b.amount - a.amount);
        break;
    }

    return res;
  }

  // ---------- 요약 계산(필터 반영) ----------
  function renderSummary(list) {
    const income = list.filter(x => x.type === 'income').reduce((s,x) => s + x.amount, 0);
    const expense = list.filter(x => x.type === 'expense').reduce((s,x) => s + x.amount, 0);
    const balance = income - expense;

    sumIncomeEl.textContent = toKRW(income);
    sumExpenseEl.textContent = toKRW(expense);
    sumBalanceEl.textContent = toKRW(balance);
  }

  // ---------- 렌더 ----------
  function render() {
    const list = getFiltered();

    tbody.innerHTML = list.map(x => {
      const badge = x.type === 'income'
        ? `<span class="badge text-bg-success badge-type">수입</span>`
        : `<span class="badge text-bg-danger badge-type">지출</span>`;

      const signAmount = x.type === 'income' ? x.amount : -x.amount;
      const amountText = (signAmount >= 0 ? '' : '-') + toKRW(Math.abs(signAmount));

      return `
        <tr>
          <td>${x.date}</td>
          <td>${badge}</td>
          <td>${x.category}</td>
          <td>${escapeHtml(x.memo)}</td>
          <td class="text-end fw-semibold">${amountText}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger" data-del="${x.id}">삭제</button>
          </td>
        </tr>
      `;
    }).join('');

    countInfo.textContent = `표시 ${list.length}건 / 전체 ${items.length}건`;
    renderSummary(list);
  }

  // XSS 방지용(내용)
  function escapeHtml(str) {
    return String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // ---------- 이벤트 ----------
  form.addEventListener('submit', (e) => {
    e.preventDefault();

    const type = typeEl.value;
    const date = dateEl.value;
    const category = categoryEl.value;
    const memo = memoEl.value.trim();
    const amount = Number(amountEl.value);

    if (!date) return alert('날짜를 선택하세요');
    if (!memo) return alert('내용을 입력하세요');
    if (!Number.isFinite(amount) || amount <= 0) return alert('금액은 1 이상 숫자만');

    items.unshift({ id: uid(), type, date, category, memo, amount });
    save();
    form.reset();

    // 기본값 다시 세팅(날짜는 오늘 유지)
    typeEl.value = 'expense';
    categoryEl.value = '식비';
    dateEl.value = new Date().toISOString().slice(0,10);

    render();
    memoEl.focus();
  });

  // 리스트 삭제(이벤트 위임)
  tbody.addEventListener('click', (e) => {
    const id = e.target?.dataset?.del;
    if (!id) return;

    if (!confirm('삭제할까요?')) return;
    items = items.filter(x => x.id !== id);
    save();
    render();
  });

  // 필터 변경 시 재렌더
  [monthFilterEl, typeFilterEl, categoryFilterEl, sortEl].forEach(el => el.addEventListener('change', render));
  searchEl.addEventListener('input', render);

  document.getElementById('resetFilters').addEventListener('click', () => {
    monthFilterEl.value = '';
    typeFilterEl.value = 'all';
    categoryFilterEl.value = 'all';
    searchEl.value = '';
    sortEl.value = 'dateDesc';
    render();
  });

  document.getElementById('clearAll').addEventListener('click', () => {
    if (!confirm('전체 내역을 삭제할까요?')) return;
    items = [];
    save();
    render();
  });

  // ---------- 초기화 ----------
  (function init() {
    load();

    // 기본 날짜: 오늘
    dateEl.value = new Date().toISOString().slice(0,10);

    // 기본 월필터: 이번 달(원하면 주석 해제)
    // monthFilterEl.value = dateEl.value.slice(0,7);

    render();
  })();
</script>
</body>
</html>
